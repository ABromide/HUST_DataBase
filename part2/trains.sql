-- 创建 trains 数据库
CREATE DATABASE IF NOT EXISTS trains;

USE trains;

SET foreign_key_checks = 0;

DROP TABLE IF EXISTS Station;
DROP TABLE IF EXISTS Train;
DROP TABLE IF EXISTS TrainPass;
DROP TABLE IF EXISTS Passenger;
DROP TABLE IF EXISTS TakeTrainRecord;
DROP TABLE IF EXISTS DiagnoseRecord;
DROP TABLE IF EXISTS TrainContactor;

-- 车站表【车站编号，车站名，所属城市】
CREATE TABLE Station(
	SID INT PRIMARY KEY, -- 车站编号 主码
	SName CHAR(20), -- 车站名
	CityName CHAR(20) -- 所属城市
)ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- 车次表【列车流水号，发车日期，列车名称，起点站编号，终点站编号，开出时刻，终点时刻】
CREATE TABLE Train(
	TID INT(11) PRIMARY KEY, -- 列车流水号 主码
	SDate DATE NOT NULL, -- 发车日期
	TName CHAR(20) NOT NULL, -- 列车名称
	SStationID INT, -- 起点站编号
	AStationID INT, -- 终点站编号
	STime DATETIME, -- 开出时刻
	ATime DATETIME, -- 终点时刻
	FOREIGN KEY (SStationID) REFERENCES Station(SID), -- 起点站编号 来源于 车站表的车站编号
	FOREIGN KEY (AStationID) REFERENCES Station(SID)  -- 终点站编号 来源于 车站表的车站编号
)ENGINE=InnoDB DEFAULT CHARSET=utf8;	

-- 车程表【列车流水号，车站序号，车站编号，到达时刻，离开时刻】
CREATE TABLE TrainPass(
	TID INT, -- 列车流水号
	SNo SMALLINT, -- 车站序号
	SID INT, -- 车站编号
	STime DATETIME, -- 到达时刻
	ATime DATETIME, -- 离开时刻
	PRIMARY KEY (TID,SNo), -- 主码为(列车流水号，车站序号)
	FOREIGN KEY (SID) REFERENCES Station(SID) -- 车站编号 来源于 车站表的车站编号
)ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- 乘客表【乘客身份证号，姓名，性别，年龄】
CREATE TABLE Passenger(
  PCardID CHAR(18) PRIMARY KEY, -- 乘客身份证号 主码
  PName CHAR(20), -- 姓名
  Sex SMALLINT CHECK (Sex IN (0,1)), -- 性别 0男 或 1女
  Age SMALLINT -- 年龄
)ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- 乘车记录表【记录编号，乘客身份证号，列车流水号，出发站编号，到达站编号，车厢号，席位排号，席位编号，席位状态】
CREATE TABLE TakeTrainRecord(
	RID INT PRIMARY KEY, -- 记录编号 主码
	PCardID CHAR(18), -- 乘客身份证号
	TID INT, -- 列车流水号
	SStationID INT, -- 出发站编号
	AStationID INT, -- 到达站编号
	CarrigeID SMALLINT, -- 车厢号
	SeatRow SMALLINT, -- 席位排号
	SeatNo CHAR(1) CHECK (SeatNo IN ('A','B','C','E','F',NULL)), -- 席位编号
	SStatus INT CHECK (SStatus IN ('0','1','2')),-- 席位状态 0-退票 1-正常 2-乘客没上车
	FOREIGN KEY (PCardID) REFERENCES Passenger(PCardID),
	FOREIGN KEY (TID) REFERENCES Train(TID),
	FOREIGN KEY (SStationID) REFERENCES Station(SID),
	FOREIGN KEY (AStationID) REFERENCES Station(SID)
)ENGINE=InnoDB AUTO_INCREMENT=18 DEFAULT CHARSET=utf8;

-- 诊断表【诊断编号，病人身份证号，诊断日期，诊断结果，发病日期】
CREATE TABLE DiagnoseRecord(
	DID INT PRIMARY KEY, -- 诊断编号 主码
	PCardID CHAR(18), -- 病人身份证号
	DDay DATE, -- 诊断日期
	DStatus SMALLINT CHECK (DStatus IN (1,2,3)), -- 诊断结果 1-新冠确诊 2-新冠疑似 3-排除新冠
	FDay DATE -- 发病日期
)ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- 乘客紧密接触者表【接触日期, 被接触者身份证号，状态，病患身份证号】
CREATE TABLE TrainContactor(
	CDate DATE, -- 接触日期
	CCardID CHAR(18), -- 被接触者身份证号
	DStatus SMALLINT CHECK (DStatus IN (1,2,3)), -- 状态 1-新冠确诊 2-新冠疑似 3-排除新冠
	PCardID CHAR(18), -- 病患身份证号
	PRIMARY KEY (CDate,CCardID,DStatus,PCardID) -- 主码为全码
)ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- 插入 车站表 数据
-- 【车站编号，车站名，所属城市】
INSERT INTO Station VALUES 
	(1,'北京站','北京市'),
	(2,'北京西站','北京市'),
	(3,'武汉站','武汉市'),
	(4,'武昌站','武汉市'),
	(5,'汉口站','武汉市'),
	(6,'上海站','上海市'),
	(7,'广州站','广州市');

-- 插入 车次表 数据
-- 【列车流水号，发车日期，列车名称，起点站编号，终点站编号，开出时刻，终点时刻】
INSERT INTO Train VALUES
	(1,'2020-01-22','复兴号',2,3,'2020-01-22 08:00:00','2020-01-22 16:00:00'),
	(2,'2020-01-22','和谐号',4,6,'2020-01-22 18:00:00','2020-01-23 02:00:00'),
	(3,'2020-01-22','复兴号',3,7,'2020-01-22 10:00:00','2020-01-22 18:00:00'),
	(4,'2020-01-22','25T',5,1,'2020-01-22 06:00:00','2020-01-22 20:00:00'),
	(5,'2020-01-22','25T',7,6,'2020-01-22 12:00:00','2020-01-22 23:00:00'),
	(6,'2020-01-21','25T',7,4,'2020-01-21 22:00:00','2020-01-22 06:00:00'),
	(7,'2020-01-22','和谐号',7,4,'2020-01-22 00:00:00','2020-01-22 07:00:00'),
	(8,'2020-01-21','复兴号',2,3,'2020-01-21 08:00:00','2020-01-21 16:00:00'),
	(9,'2020-01-22','G007',1,6,'2020-01-22 10:00:00','2020-01-22 22:00:00'),
	(10,'2020-01-22','25T',7,4,'2020-01-22 22:00:00','2020-01-23 06:00:00'),
	(11,'2020-01-01','复兴号',2,3,'2020-01-01 08:00:00','2020-01-01 16:00:00'),
	(12,'2020-01-22','和谐号',2,7,'2020-01-22 07:00:00','2020-01-22 16:00:00'),
	(13,'2020-01-10','和谐号',2,7,'2020-01-10 07:00:00','2020-01-10 16:00:00');

-- 插入 车程表 数据
-- 【列车流水号，车站序号，车站编号，到达时刻，离开时刻】
INSERT INTO TrainPass VALUES 
	(1,1,2,NULL,'2020-01-22 08:00:00'),
	(1,2,3,'2020-01-22 16:00:00',NULL),
	(2,1,4,NULL,'2020-01-22 18:00:00'),
	(2,2,6,'2020-01-23 02:00:00',NULL),
	(3,1,3,NULL,'2020-01-22 10:00:00'),
	(3,2,7,'2020-01-22 18:00:00',NULL),
	(4,1,5,NULL,'2020-01-22 06:00:00'),
	(4,2,1,'2020-01-22 20:00:00',NULL),
	(5,1,7,NULL,'2020-01-22 12:00:00'),
	(5,2,6,'2020-01-22 23:00:00',NULL),
	(6,1,7,NULL,'2020-01-21 22:00:00'),
	(6,2,4,'2020-01-22 06:00:00',NULL),
	(7,1,7,NULL,'2020-01-22 00:00:00'),
	(7,2,4,'2020-01-22 07:00:00',NULL),
	(8,1,2,NULL,'2020-01-21 08:00:00'),
	(8,2,3,'2020-01-21 16:00:00',NULL),
	(9,1,1,NULL,'2020-01-22 10:00:00'),
	(9,2,6,'2020-01-22 22:00:00',NULL),
	(10,1,7,NULL,'2020-01-22 22:00:00'),
	(10,2,4,'2020-01-23 06:00:00',NULL),
	(11,1,2,NULL,'2020-01-01 08:00:00'),
	(11,2,3,'2020-01-01 16:00:00',NULL),
	(12,1,2,NULL,'2020-01-22 07:00:00'),
	(12,2,3,'2020-01-22 11:30:00','2020-01-22 11:35:00'),
	(12,3,7,'2020-01-22 16:00:00',NULL),
	(13,1,2,NULL,'2020-01-10 07:00:00'),
	(13,2,3,'2020-01-10 11:30:00','2020-01-10 11:35:00'),
	(13,3,7,'2020-01-10 16:00:00',NULL);

-- 插入 乘客表 数据
-- 【乘客身份证号，姓名，性别，年龄】
INSERT INTO Passenger VALUES 
	('210101198001010000','张浩琦',0,40),
	('210101198001010010','韩季霖',1,40),
	('210101200001010000','李四',0,20),
	('210101200001010010','张三',1,20),
	('210101200001010011','王五',1,20),
	('210101200001010015','俞洪锐',1,20),
	('420101196001010000','莫力',0,60),
	('420101197001010010','黄志雄',1,50),
	('420101199001010000','朱忆韩',0,30),
	('420101199001010010','马笑天',1,30);

-- 插入 乘车记录表 数据
-- 【记录编号，乘客身份证号，列车流水号，出发站编号，到达站编号，车厢号，席位排号，席位编号，席位状态】
INSERT INTO TakeTrainRecord VALUES 
	(1,'210101200001010010',1,2,3,5,8,'A',1), -- 张三
	(2,'210101200001010010',2,4,6,2,10,'F',1), -- 张三
	(3,'210101200001010000',3,3,7,4,4,'B',0), -- 李四
	(4,'210101200001010011',4,5,1,8,2,'A',1), -- 王五
	(5,'210101200001010000',3,3,7,7,1,'B',1), -- 李四
	(6,'210101198001010000',5,7,6,6,3,'E',1), -- 张浩琦
	(7,'210101198001010010',7,7,4,7,12,'C',1), -- 韩季霖
	(8,'420101199001010010',6,7,4,NULL,NULL,NULL,1), -- 马笑天
	(9,'420101199001010000',9,1,6,4,7,'A',1), -- 朱忆韩
	(10,'420101196001010000',9,1,6,4,10,'A',1), -- 莫力
	(11,'420101197001010010',9,1,6,4,10,'C',1), -- 黄志雄
	(12,'210101200001010000',10,7,4,5,12,'F',1), -- 李四
	(13,'210101200001010015',3,3,7,7,5,'B',1), -- 俞洪锐
	(14,'210101200001010015',10,7,4,5,10,'F',1), -- 俞洪锐
	(15,'420101199001010000',8,2,3,9,1,'E',2), -- 朱忆韩
	(16,'210101200001010010',11,2,3,5,6,'A',1), -- 张三
	(17,'210101200001010011',13,2,7,1,4,'A',1); -- 王五

-- 插入 诊断表 数据
-- 【诊断编号，病人身份证号，诊断日期，诊断结果，发病日期】
INSERT INTO DiagnoseRecord VALUES 
	(1,'210101200001010010','2020-01-28',1,'2020-01-27'), -- 张三
	(2,'210101200001010000','2020-01-29',1,'2020-01-27'), -- 李四
	(3,'420101199001010000','2020-01-30',1,'2020-01-28'), -- 朱忆韩
	(4,'420101199001010010','2020-01-30',1,'2020-01-28'), -- 马笑天
	(5,'210101200001010011','2020-01-31',3,'2020-01-24'); -- 王五

-- 插入 乘客紧密接触者表 数据
-- 【接触日期, 被接触者身份证号，状态，病患身份证号】
INSERT INTO TrainContactor VALUES 
	('2020-01-22','210101200001010015',1,'210101200001010000'), -- 俞洪锐 李四
	('2020-01-22','420101196001010000',1,'420101199001010000'), -- 莫力 朱忆韩
	('2020-01-22','420101197001010010',1,'420101199001010000'); -- 黄志雄 朱忆韩


SET foreign_key_checks = 1;

SELECT 'ok' as 'result:';
